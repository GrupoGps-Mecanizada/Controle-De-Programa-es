<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle De Equipamentos e Programa√ß√µes - GrupoGps</title>

    <!-- Bibliotecas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        /* Header Sofisticado */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-brand h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            font-size: 0.9rem;
            color: #5a6c7d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .last-update-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sync-dot.success { background: #27ae60; }
        .sync-dot.error { background: #e74c3c; }
        .sync-dot.loading { background: #f39c12; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .panel-content {
            padding: 1.5rem;
        }

        /* Compact Stats */
        .compact-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .compact-stat-card {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .compact-stat-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.95);
        }

        .compact-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .compact-stat-label {
            font-size: 0.8rem;
            color: #5a6c7d;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        /* Controls */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        input[type="text"] {
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            color: #2c3e50;
            width: 300px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 0.95);
        }

        /* Equipment Table */
        .equipment-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.85rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #5a6c7d;
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem;
            text-align: center;
            color: #5a6c7d;
            font-size: 0.9rem;
        }

        .footer strong {
            color: #2c3e50;
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            backdrop-filter: blur(20px);
        }

        .notification.success { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .notification.error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .notification.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .notification.info { background: linear-gradient(135deg, #3498db, #2980b9); }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Status de valida√ß√£o */
        .validation-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .validation-status.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #16a34a;
        }

        .validation-status.warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #d97706;
        }

        .validation-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .header-brand h1 {
                font-size: 1.5rem;
            }

            .main-content {
                padding: 1rem;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .search-group {
                justify-content: center;
            }

            input[type="text"] {
                width: 100%;
            }

            .compact-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 6px;
            }
        }

        /* Hidden utilities */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-brand">
                    <h1>üöõ Controle De Equipamentos e Programa√ß√µes - GrupoGps</h1>
                </div>
                
                <div class="header-controls">
                    <div class="sync-indicator">
                        <div class="sync-dot loading" id="syncDot"></div>
                        <span id="syncStatus">Carregando dados...</span>
                    </div>
                    
                    <div class="last-update-info">
                        <span style="font-size: 0.85rem; color: #5a6c7d;">√öltima atualiza√ß√£o:</span>
                        <span id="lastUpdateTime" style="font-weight: 600; color: #2c3e50;">--:--</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Estat√≠sticas Compactas -->
            <div class="compact-stats" id="compactStats">
                <div class="compact-stat-card">
                    <div class="compact-stat-value" id="totalEquipamentos">0</div>
                    <div class="compact-stat-label">Equipamentos</div>
                </div>
                <div class="compact-stat-card">
                    <div class="compact-stat-value" id="totalProgramacoes">0</div>
                    <div class="compact-stat-label">Programa√ß√µes</div>
                </div>
                <div class="compact-stat-card">
                    <div class="compact-stat-value" id="equipamentosComMotorista">0</div>
                    <div class="compact-stat-label">Com Motorista</div>
                </div>
                <div class="compact-stat-card">
                    <div class="compact-stat-value" id="dataAtual">--</div>
                    <div class="compact-stat-label">Data Atual</div>
                </div>
            </div>

            <!-- Status de Valida√ß√£o -->
            <div id="validationStatus" class="validation-status hidden">
                <span id="validationIcon">‚úÖ</span>
                <span id="validationMessage">Dados validados com sucesso</span>
            </div>

            <!-- Painel Principal -->
            <div class="glass-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>üìã</span>
                        Equipamentos e Programa√ß√µes Consolidadas
                    </div>
                    <div id="totalRegistros" style="font-size: 0.9rem; color: #5a6c7d;">
                        0 registros
                    </div>
                </div>
                <div class="panel-content">
                    <!-- Controles -->
                    <div class="controls-row">
                        <div class="search-group">
                            <input type="text" id="searchInput" placeholder="Buscar por vaga, equipamento ou motorista..." />
                            <button class="btn" onclick="filtrarTabela()">
                                <span>üîç</span>
                                Buscar
                            </button>
                        </div>
                        
                        <div class="search-group">
                            <button class="btn danger" onclick="exportarPDF()">
                                <span>üìë</span>
                                Exportar PDF
                            </button>
                            <button class="btn" onclick="atualizarDados()">
                                <span>üîÑ</span>
                                Atualizar
                            </button>
                            <button class="btn secondary" onclick="executarDiagnostico()">
                                <span>üîç</span>
                                Diagn√≥stico
                            </button>
                        </div>
                    </div>

                    <!-- Tabela de Dados -->
                    <div class="equipment-table" id="dataTable">
                        <div class="loading-state">
                            <div class="loading-spinner"></div>
                            <div>Carregando dados do GitHub...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>Desenvolvido por <strong>Warlison Abreu</strong> | ¬© 2025 GrupoGPS - Todos os direitos reservados</p>
        </footer>
    </div>

    <script>
        /*********************************
         * CONFIGURA√á√ïES GITHUB          *
         *********************************/
        const GITHUB_CONFIG = {
            TOKEN: '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',
            OWNER: 'GrupoGps-Mecanizada',
            REPO: 'Controle-De-Programa-es',
            BRANCH: 'main',
            FILES: {
                APROPRIACOES: 'data/apropriacoes/apropriacao-latest.csv',
                ATENDIMENTOS: 'data/atendimentos/atendimento-latest.csv',
                CHECKLIST: 'data/checklist-dados.csv'
            }
        };

        /*********************************
         * ORDENA√á√ÉO DE EQUIPAMENTOS     *
         *********************************/
        const ORDEM_EQUIPAMENTOS = [
            // ALTA PRESS√ÉO (AP)
            'AP - 01 - 24HS',
            'AP - 02',
            'AP - 03', 
            'AP - 04',
            'AP - 05',
            'AP - 06',
            'AP - 07',
            'AP - 08 - 24HS',
            'AP - 09',
            'AP - 10',
            'AP - 11',
            'AP - 12',
            // AUTO V√ÅCUO (AV)
            'AV - 01 - 16HS',
            'AV - 02 - 16HS',
            'AV - 03',
            'AV - 04',
            'AV - 05',
            'AV - 06', 
            'AV - 07',
            'AV - 08 - 24HS',
            'AV - 09',
            'AV - 10',
            // HIPER V√ÅCUO (HV)
            'HV - 01',
            'HV - 02'
        ];

        function aplicarSiglas(nomeEquipamento) {
            if (!nomeEquipamento) return '';
            
            let resultado = nomeEquipamento;
            
            // Aplicar siglas
            resultado = resultado.replace(/CAMINH√ÉO ALTA PRESS√ÉO/g, 'AP');
            resultado = resultado.replace(/CAMINH√ÉO AUTO V√ÅCUO/g, 'AV');
            resultado = resultado.replace(/CAMINH√ÉO HIPER V√ÅCUO/g, 'HV');
            
            // Limpar redund√¢ncias
            resultado = resultado.replace(/- GPS/g, '');
            resultado = resultado.replace(/24 HS/g, '24HS');
            resultado = resultado.replace(/16 HS/g, '16HS');
            
            // Limpar espa√ßos duplos
            resultado = resultado.replace(/\s+/g, ' ').trim();
            
            return resultado;
        }

        /*********************************
         * ESTADO GLOBAL                 *
         *********************************/
        let dadosConsolidados = [];
        let dadosFiltrados = [];
        let lastSyncTime = null;
        let validationResults = {
            status: 'pending',
            message: '',
            errors: [],
            warnings: []
        };

        /*********************************
         * FUN√á√ïES DE SEGURAN√áA E VALIDA√á√ÉO *
         *********************************/
        function validarDadosEntrada(dados, nomeArquivo) {
            const resultados = {
                valido: true,
                erros: [],
                avisos: [],
                estatisticas: {
                    total: dados.length,
                    validos: 0,
                    invalidos: 0
                }
            };

            if (!Array.isArray(dados)) {
                resultados.valido = false;
                resultados.erros.push(`${nomeArquivo}: Dados n√£o s√£o um array v√°lido`);
                return resultados;
            }

            if (dados.length === 0) {
                resultados.valido = false;
                resultados.erros.push(`${nomeArquivo}: Arquivo est√° vazio`);
                return resultados;
            }

            // Validar estrutura dos dados
            dados.forEach((item, index) => {
                try {
                    if (!item || typeof item !== 'object') {
                        resultados.erros.push(`${nomeArquivo}: Linha ${index + 1} - Item inv√°lido`);
                        resultados.estatisticas.invalidos++;
                        return;
                    }

                    // Sanitizar dados
                    Object.keys(item).forEach(key => {
                        if (typeof item[key] === 'string') {
                            item[key] = item[key].trim().replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                        }
                    });

                    resultados.estatisticas.validos++;
                } catch (error) {
                    resultados.erros.push(`${nomeArquivo}: Linha ${index + 1} - Erro de processamento: ${error.message}`);
                    resultados.estatisticas.invalidos++;
                }
            });

            if (resultados.estatisticas.invalidos > 0) {
                resultados.avisos.push(`${nomeArquivo}: ${resultados.estatisticas.invalidos} registros com problemas encontrados`);
            }

            console.log(`‚úÖ Valida√ß√£o ${nomeArquivo}:`, resultados);
            return resultados;
        }

        function sanitizarTexto(texto) {
            if (!texto) return '';
            
            return String(texto)
                .trim()
                .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Remove caracteres de controle
                .replace(/[^\w\s\-\/\.\:\,\(\)]/g, '') // Remove caracteres especiais perigosos
                .substring(0, 500); // Limita tamanho para evitar overflow
        }

        function ordenarEquipamentos(dados) {
            return dados.sort((a, b) => {
                const equipamentoA = a.equipamento;
                const equipamentoB = b.equipamento;
                
                // Encontrar √≠ndice na ordem predefinida
                let indexA = -1;
                let indexB = -1;
                
                // Buscar correspond√™ncia mais precisa
                for (let i = 0; i < ORDEM_EQUIPAMENTOS.length; i++) {
                    const padrao = ORDEM_EQUIPAMENTOS[i];
                    
                    if (equipamentoA.includes(padrao)) {
                        indexA = i;
                    }
                    if (equipamentoB.includes(padrao)) {
                        indexB = i;
                    }
                }
                
                // Se ambos est√£o na lista de ordem, usar a ordem predefinida
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                
                // Se apenas um est√° na lista, ele vem primeiro
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                
                // Se nenhum est√° na lista, ordem alfab√©tica
                return equipamentoA.localeCompare(equipamentoB);
            });
        }

        function filtrarDuplicatasEquipamentos(apropriacoes) {
            console.log('üîÑ Removendo duplicatas de equipamentos...');
            
            // Agrupar por equipamento
            const equipamentosMap = new Map();
            
            apropriacoes.forEach(apropriacao => {
                const equipamento = apropriacao.Equipamento;
                
                if (!equipamentosMap.has(equipamento)) {
                    equipamentosMap.set(equipamento, []);
                }
                
                equipamentosMap.get(equipamento).push(apropriacao);
            });
            
            // Para cada equipamento, pegar apenas a apropria√ß√£o mais recente do per√≠odo 06:00-11:00
            const apropriacoesFiltradas = [];
            
            equipamentosMap.forEach((apropriacoesEquipamento, equipamento) => {
                // Filtrar por hor√°rio 06:00-11:00
                const apropriacoesHorario = apropriacoesEquipamento.filter(item => {
                    if (!item['Data/Hora inicial']) return false;
                    
                    const dataHora = item['Data/Hora inicial'];
                    const horaParte = dataHora.split(' ')[1]; // Pegar apenas a hora
                    
                    if (!horaParte) return false;
                    
                    const [hora] = horaParte.split(':');
                    const horaNum = parseInt(hora);
                    
                    return horaNum >= 6 && horaNum <= 11;
                });
                
                if (apropriacoesHorario.length > 0) {
                    // Ordenar por data/hora inicial e pegar a mais recente
                    apropriacoesHorario.sort((a, b) => {
                        return new Date(`2025-07-03 ${a['Data/Hora inicial'].split(' ')[1]}`) - 
                               new Date(`2025-07-03 ${b['Data/Hora inicial'].split(' ')[1]}`);
                    });
                    
                    // Pegar a apropria√ß√£o mais recente
                    apropriacoesFiltradas.push(apropriacoesHorario[apropriacoesHorario.length - 1]);
                }
            });
            
            console.log(`‚úÖ Duplicatas removidas: ${apropriacoes.length} ‚Üí ${apropriacoesFiltradas.length} registros`);
            return apropriacoesFiltradas;
        }

        /*********************************
         * FUN√á√ïES DE ACESSO AO GITHUB   *
         *********************************/
        async function fetchGitHubFile(filePath) {
            console.log(`üîÑ Carregando arquivo: ${filePath}`);
            
            const MAX_RETRIES = 3;
            let lastError;
            
            for (let tentativa = 1; tentativa <= MAX_RETRIES; tentativa++) {
                try {
                    console.log(`üîÑ Tentativa ${tentativa}/${MAX_RETRIES} para ${filePath}`);
                    
                    // M√©todo 1: API do GitHub
                    const url = `https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${filePath}`;
                    
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        timeout: 15000 // 15 segundos timeout
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const content = atob(data.content.replace(/\s/g, ''));
                        console.log(`‚úÖ Arquivo carregado via API: ${filePath} (${content.length} caracteres)`);
                        return content;
                    }
                    
                    // M√©todo 2: Raw GitHub (fallback)
                    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/${GITHUB_CONFIG.BRANCH}/${filePath}`;
                    const rawResponse = await fetch(rawUrl + '?v=' + Date.now());
                    
                    if (rawResponse.ok) {
                        const content = await rawResponse.text();
                        console.log(`‚úÖ Arquivo carregado via RAW: ${filePath} (${content.length} caracteres)`);
                        return content;
                    }
                    
                    throw new Error(`Ambos os m√©todos falharam - API: ${response.status}, RAW: ${rawResponse.status}`);
                    
                } catch (error) {
                    lastError = error;
                    console.warn(`‚ö†Ô∏è Tentativa ${tentativa} falhou para ${filePath}:`, error.message);
                    
                    if (tentativa < MAX_RETRIES) {
                        const delay = tentativa * 2000; // Delay progressivo
                        console.log(`‚è≥ Aguardando ${delay}ms antes da pr√≥xima tentativa...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw new Error(`Falha ao carregar ${filePath} ap√≥s ${MAX_RETRIES} tentativas. √öltimo erro: ${lastError.message}`);
        }

        async function carregarTodosOsArquivos() {
            try {
                updateSyncStatus('loading', 'Iniciando carregamento seguro...');
                updateValidationStatus('pending', 'Validando integridade dos dados...');
                
                console.log('üîÑ === IN√çCIO DO CARREGAMENTO SEGURO ===');
                
                // Carregar arquivos com timeout e retry
                const [apropriacoesContent, atendimentosContent, checklistContent] = await Promise.all([
                    fetchGitHubFile(GITHUB_CONFIG.FILES.APROPRIACOES),
                    fetchGitHubFile(GITHUB_CONFIG.FILES.ATENDIMENTOS),
                    fetchGitHubFile(GITHUB_CONFIG.FILES.CHECKLIST)
                ]);
                
                // Processar e validar cada arquivo
                const dadosApropriacoes = parseCSVContent(apropriacoesContent);
                const dadosAtendimentos = parseCSVContent(atendimentosContent);
                const dadosChecklist = parseCSVContent(checklistContent);
                
                // Validar dados de entrada
                const validacaoApropriacoes = validarDadosEntrada(dadosApropriacoes, 'Apropria√ß√µes');
                const validacaoAtendimentos = validarDadosEntrada(dadosAtendimentos, 'Atendimentos');
                const validacaoChecklist = validarDadosEntrada(dadosChecklist, 'Checklist');
                
                // Consolidar resultados de valida√ß√£o
                const todasValidacoes = [validacaoApropriacoes, validacaoAtendimentos, validacaoChecklist];
                const temErros = todasValidacoes.some(v => !v.valido);
                
                if (temErros) {
                    const erros = todasValidacoes.flatMap(v => v.erros);
                    updateValidationStatus('error', `Erros encontrados na valida√ß√£o: ${erros.length} problemas`);
                    throw new Error(`Valida√ß√£o falhou: ${erros.join('; ')}`);
                }
                
                console.log(`üìä Dados carregados e validados:
                - Apropria√ß√µes: ${dadosApropriacoes.length} registros
                - Atendimentos: ${dadosAtendimentos.length} registros  
                - Checklist: ${dadosChecklist.length} registros`);
                
                // Consolidar os dados
                dadosConsolidados = consolidarDados(dadosApropriacoes, dadosAtendimentos, dadosChecklist);
                
                // Ordenar equipamentos conforme especifica√ß√£o
                dadosConsolidados = ordenarEquipamentos(dadosConsolidados);
                
                lastSyncTime = new Date();
                updateSyncStatus('success', `${dadosConsolidados.length} registros consolidados`);
                updateValidationStatus('success', `Dados processados com seguran√ßa: ${dadosConsolidados.length} registros`);
                updateLastSyncTime();
                
                atualizarInterface();
                
                showNotification(`‚úÖ Dados carregados com seguran√ßa! ${dadosConsolidados.length} registros processados e ordenados.`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro no carregamento:', error);
                updateSyncStatus('error', 'Erro: ' + error.message);
                updateValidationStatus('error', 'Falha na valida√ß√£o: ' + error.message);
                showNotification('‚ùå Erro ao carregar dados: ' + error.message, 'error');
            }
        }

        /*********************************
         * FUN√á√ïES DE PROCESSAMENTO      *
         *********************************/
        function parseCSVContent(csvString) {
            try {
                if (!csvString || csvString.trim().length === 0) {
                    throw new Error('Conte√∫do CSV est√° vazio');
                }
                
                console.log('üîÑ Iniciando parse seguro do CSV...');
                
                // Detectar delimiter de forma mais robusta
                const delimiters = [',', ';', '\t'];
                let bestDelimiter = ',';
                let maxColumns = 0;
                
                for (const delimiter of delimiters) {
                    const testResult = Papa.parse(csvString.substring(0, 1000), {
                        delimiter: delimiter,
                        header: true
                    });
                    
                    if (testResult.meta.fields && testResult.meta.fields.length > maxColumns) {
                        maxColumns = testResult.meta.fields.length;
                        bestDelimiter = delimiter;
                    }
                }
                
                console.log(`üîç Melhor delimitador detectado: "${bestDelimiter}" (${maxColumns} colunas)`);
                
                const result = Papa.parse(csvString, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: bestDelimiter,
                    transformHeader: header => sanitizarTexto(header),
                    transform: (value) => sanitizarTexto(value),
                    dynamicTyping: false // Manter como string para controle total
                });
                
                if (result.errors.length > 0) {
                    console.warn('‚ö†Ô∏è Avisos no parse CSV:', result.errors);
                }
                
                const validData = result.data.filter(linha => {
                    // Verificar se a linha tem pelo menos um campo n√£o vazio
                    return Object.values(linha).some(val => val && val.toString().trim() !== '');
                });
                
                console.log(`‚úÖ Parse conclu√≠do: ${validData.length} registros v√°lidos de ${result.data.length} total`);
                return validData;
                
            } catch (error) {
                console.error('‚ùå Erro no parse CSV:', error);
                throw new Error(`Erro ao processar CSV: ${error.message}`);
            }
        }

        function consolidarDados(apropriacoes, atendimentos, checklist) {
            console.log('üîÑ Iniciando consolida√ß√£o segura dos dados...');
            
            const hoje = new Date();
            const dataAtual = hoje.toLocaleDateString('pt-BR');
            
            console.log(`üìÖ Filtrando dados para o dia: ${dataAtual}`);
            
            // Criar mapeamento seguro de equipamentos para motoristas
            const equipamentoParaMotorista = {};
            let motoristasMapeados = 0;
            
            checklist.forEach((item, index) => {
                try {
                    if (item.Placa && item.Motorista && 
                        item.Placa !== '--' && 
                        item.Placa.trim() !== '' &&
                        item.Motorista.trim() !== '') {
                        
                        const placa = sanitizarTexto(item.Placa);
                        const motorista = sanitizarTexto(item.Motorista);
                        
                        equipamentoParaMotorista[placa] = motorista;
                        motoristasMapeados++;
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro no mapeamento linha ${index}:`, error.message);
                }
            });
            
            console.log(`üë®‚Äçüíº Motoristas mapeados com seguran√ßa: ${motoristasMapeados}`);
            
            // Filtrar apropria√ß√µes do dia atual
            const apropriacoesDia = apropriacoes.filter((item, index) => {
                try {
                    // Valida√ß√µes de seguran√ßa
                    if (!item.Equipamento || 
                        item.Equipamento === '--' || 
                        item.Equipamento.trim() === '') {
                        return false;
                    }
                    
                    if (!item['Data/Hora inicial']) {
                        return false;
                    }
                    
                    const dataInicial = item['Data/Hora inicial'].split(' ')[0];
                    return dataInicial === dataAtual;
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro ao filtrar linha ${index}:`, error.message);
                    return false;
                }
            });
            
            // Remover duplicatas e filtrar por hor√°rio (06:00-11:00)
            const apropriacoesFiltradas = filtrarDuplicatasEquipamentos(apropriacoesDia);
            
            console.log(`‚úÖ Apropria√ß√µes filtradas: ${apropriacoesFiltradas.length} registros √∫nicos no hor√°rio 06:00-11:00`);
            
            // Consolidar dados de forma segura
            const dadosConsolidados = [];
            let sucessos = 0;
            let erros = 0;
            
            apropriacoesFiltradas.forEach((apropriacao, index) => {
                try {
                    const vaga = sanitizarTexto(apropriacao.Vaga);
                    const equipamentoOriginal = sanitizarTexto(apropriacao.Equipamento);
                    const equipamentoComSigla = aplicarSiglas(equipamentoOriginal);
                    
                    // Buscar atendimento de forma segura
                    let atendimento = null;
                    try {
                        atendimento = atendimentos.find(item => 
                            item.Vaga && 
                            sanitizarTexto(item.Vaga) === vaga
                        );
                    } catch (err) {
                        console.warn(`‚ö†Ô∏è Erro ao buscar atendimento para vaga ${vaga}:`, err.message);
                    }
                    
                    // Buscar motorista usando o nome original do equipamento
                    const motorista = equipamentoParaMotorista[equipamentoOriginal] || 'N√£o identificado';
                    
                    const registro = {
                        vaga: vaga || 'N/D',
                        equipamento: equipamentoComSigla,
                        motorista: motorista,
                        programacao: atendimento ? sanitizarTexto(atendimento['Data/Hora']) : 'Programa√ß√£o n√£o encontrada',
                        area: atendimento ? sanitizarTexto(atendimento['√Årea(local)']) : '√Årea n√£o encontrada'
                    };
                    
                    dadosConsolidados.push(registro);
                    sucessos++;
                    
                } catch (error) {
                    console.error(`‚ùå Erro ao processar registro ${index}:`, error.message);
                    erros++;
                }
            });
            
            console.log(`üìä Consolida√ß√£o conclu√≠da:
            - Sucessos: ${sucessos}
            - Erros: ${erros}
            - Taxa de sucesso: ${(sucessos / (sucessos + erros) * 100).toFixed(1)}%`);
            
            return dadosConsolidados;
        }

        /*********************************
         * FUN√á√ïES DE INTERFACE          *
         *********************************/
        function atualizarInterface() {
            atualizarEstatisticas();
            exibirTabela();
        }

        function atualizarEstatisticas() {
            const totalEquipamentos = new Set(dadosConsolidados.map(item => item.equipamento)).size;
            const totalProgramacoes = dadosConsolidados.length;
            const equipamentosComMotorista = dadosConsolidados.filter(item => item.motorista !== 'N√£o identificado').length;
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            
            document.getElementById('totalEquipamentos').textContent = totalEquipamentos;
            document.getElementById('totalProgramacoes').textContent = totalProgramacoes;
            document.getElementById('equipamentosComMotorista').textContent = equipamentosComMotorista;
            document.getElementById('dataAtual').textContent = dataAtual.substring(0, 5); // DD/MM
            document.getElementById('totalRegistros').textContent = `${dadosConsolidados.length} registros`;
        }

        function exibirTabela() {
            const container = document.getElementById('dataTable');
            const dados = dadosFiltrados.length > 0 ? dadosFiltrados : dadosConsolidados;
            
            if (!dados.length) {
                container.innerHTML = '<div class="loading-state"><div>Nenhum dado encontrado</div></div>';
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Vaga</th>
                            <th>Equipamento</th>
                            <th>Motorista</th>
                            <th>Programa√ß√£o</th>
                            <th>√Årea</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            dados.forEach(registro => {
                tableHTML += `
                    <tr>
                        <td>${registro.vaga}</td>
                        <td><strong>${registro.equipamento}</strong></td>
                        <td>${registro.motorista}</td>
                        <td>${registro.programacao}</td>
                        <td>${registro.area}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function filtrarTabela() {
            const searchTerm = sanitizarTexto(document.getElementById('searchInput').value).toLowerCase();
            
            if (!searchTerm) {
                dadosFiltrados = [];
                exibirTabela();
                return;
            }
            
            dadosFiltrados = dadosConsolidados.filter(registro => {
                return (
                    registro.vaga.toLowerCase().includes(searchTerm) ||
                    registro.equipamento.toLowerCase().includes(searchTerm) ||
                    registro.motorista.toLowerCase().includes(searchTerm) ||
                    registro.area.toLowerCase().includes(searchTerm)
                );
            });
            
            exibirTabela();
            
            if (dadosFiltrados.length === 0) {
                showNotification('Nenhum resultado encontrado para a busca.', 'warning');
            } else {
                showNotification(`${dadosFiltrados.length} registros encontrados.`, 'success');
            }
        }

        /*********************************
         * EXPORTA√á√ÉO PDF                *
         *********************************/
        function exportarPDF() {
            try {
                const dados = dadosFiltrados.length > 0 ? dadosFiltrados : dadosConsolidados;
                
                if (!dados.length) {
                    showNotification('Nenhum dado para exportar.', 'warning');
                    return;
                }
                
                showNotification('Gerando PDF...', 'info');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');
                
                // Configura√ß√µes do documento
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                
                // Cabe√ßalho simplificado
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('Controle de Equipamentos e Programa√ß√µes', pageWidth / 2, 30, { align: 'center' });
                
                // Data/hora do relat√≥rio
                doc.setFontSize(10);
                const agora = new Date().toLocaleString('pt-BR');
                doc.text(`Gerado em: ${agora}`, margin, 45);
                doc.text(`Total de registros: ${dados.length}`, pageWidth - margin - 50, 45);
                
                // Preparar dados para a tabela (sem Data/Hora Inicial e Final)
                const colunas = [
                    'Vaga',
                    'Equipamento', 
                    'Motorista',
                    'Programa√ß√£o',
                    '√Årea'
                ];
                
                const linhas = dados.map(registro => [
                    registro.vaga,
                    registro.equipamento,
                    registro.motorista,
                    registro.programacao,
                    registro.area
                ]);
                
                // Configurar tabela
                doc.autoTable({
                    head: [colunas],
                    body: linhas,
                    startY: 55,
                    theme: 'striped',
                    styles: {
                        fontSize: 9,
                        cellPadding: 4,
                        overflow: 'linebreak',
                        halign: 'left'
                    },
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 10
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { cellWidth: 35 }, // Vaga
                        1: { cellWidth: 60 }, // Equipamento
                        2: { cellWidth: 55 }, // Motorista
                        3: { cellWidth: 60 }, // Programa√ß√£o
                        4: { cellWidth: 45 }  // √Årea
                    },
                    margin: { top: 55, left: margin, right: margin },
                    didDrawPage: function(data) {
                        // N√∫mero da p√°gina (sem rodap√© com cr√©ditos)
                        doc.setFontSize(8);
                        doc.setFont(undefined, 'normal');
                        doc.text(
                            `P√°gina ${data.pageNumber}`,
                            pageWidth / 2,
                            pageHeight - 10,
                            { align: 'center' }
                        );
                    }
                });
                
                // Salvar o PDF
                const nomeArquivo = `Controle_Equipamentos_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '_')}.pdf`;
                doc.save(nomeArquivo);
                
                showNotification(`PDF exportado com sucesso: ${nomeArquivo}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao exportar PDF:', error);
                showNotification('Erro ao gerar PDF: ' + error.message, 'error');
            }
        }

        function atualizarDados() {
            carregarTodosOsArquivos();
        }

        /*********************************
         * FUN√á√ïES AUXILIARES            *
         *********************************/
        function updateSyncStatus(status, message) {
            const dot = document.getElementById('syncDot');
            const statusText = document.getElementById('syncStatus');
            
            dot.className = 'sync-dot';
            dot.classList.add(status);
            statusText.textContent = message;
        }

        function updateValidationStatus(status, message) {
            const container = document.getElementById('validationStatus');
            const icon = document.getElementById('validationIcon');
            const messageElement = document.getElementById('validationMessage');
            
            container.className = `validation-status ${status}`;
            messageElement.textContent = message;
            
            switch(status) {
                case 'success':
                    icon.textContent = '‚úÖ';
                    container.classList.remove('hidden');
                    break;
                case 'error':
                    icon.textContent = '‚ùå';
                    container.classList.remove('hidden');
                    break;
                case 'warning':
                    icon.textContent = '‚ö†Ô∏è';
                    container.classList.remove('hidden');
                    break;
                case 'pending':
                    icon.textContent = 'üîÑ';
                    container.classList.remove('hidden');
                    break;
                default:
                    container.classList.add('hidden');
            }
        }

        function updateLastSyncTime() {
            const lastUpdateTimeElement = document.getElementById('lastUpdateTime');
            if (lastUpdateTimeElement) {
                lastUpdateTimeElement.textContent = new Date().toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        async function executarDiagnostico() {
            try {
                console.log('üîç === INICIANDO DIAGN√ìSTICO COMPLETO ===');
                
                updateValidationStatus('pending', 'Executando diagn√≥stico completo...');
                
                // Teste de conectividade
                console.log('üåê Testando conectividade...');
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro de conectividade: ${response.status}`);
                }
                
                const repoInfo = await response.json();
                console.log(`‚úÖ Conectado ao reposit√≥rio: ${repoInfo.full_name}`);
                
                // Verificar estrutura de arquivos
                console.log('üìÇ Verificando arquivos...');
                for (const [nome, caminho] of Object.entries(GITHUB_CONFIG.FILES)) {
                    try {
                        const fileResponse = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.OWNER}/${GITHUB_CONFIG.REPO}/contents/${caminho}`, {
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.TOKEN}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        console.log(`  ${nome}: ${fileResponse.ok ? '‚úÖ' : '‚ùå'} (${fileResponse.status})`);
                    } catch (err) {
                        console.log(`  ${nome}: ‚ùå Erro - ${err.message}`);
                    }
                }
                
                // Estat√≠sticas dos dados atuais
                console.log('üìä Estat√≠sticas dos dados:');
                console.log(`  - Registros consolidados: ${dadosConsolidados.length}`);
                console.log(`  - Equipamentos √∫nicos: ${new Set(dadosConsolidados.map(item => item.equipamento)).size}`);
                console.log(`  - Com motorista: ${dadosConsolidados.filter(item => item.motorista !== 'N√£o identificado').length}`);
                
                updateValidationStatus('success', `Diagn√≥stico conclu√≠do com sucesso - Sistema operacional`);
                showNotification('‚úÖ Diagn√≥stico conclu√≠do - Sistema funcionando corretamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro no diagn√≥stico:', error);
                updateValidationStatus('error', `Diagn√≥stico falhou: ${error.message}`);
                showNotification('‚ùå Erro no diagn√≥stico: ' + error.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filtrarTabela();
            }
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            if (e.target.value === '') {
                dadosFiltrados = [];
                exibirTabela();
            }
        });

        /*********************************
         * INICIALIZA√á√ÉO                 *
         *********************************/
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöõ Iniciando Sistema Refinado - Controle de Equipamentos GrupoGPS');
            
            updateSyncStatus('loading', 'Inicializando sistema seguro...');
            updateValidationStatus('pending', 'Preparando valida√ß√µes...');
            updateLastSyncTime();
            
            // Inicializa√ß√£o com delay para melhor UX
            setTimeout(() => {
                carregarTodosOsArquivos();
            }, 1000);
            
            // Auto-atualiza√ß√£o a cada 5 minutos
            setInterval(() => {
                console.log('üîÑ Auto-atualiza√ß√£o programada executando...');
                carregarTodosOsArquivos();
            }, 5 * 60 * 1000);
            
            console.log('‚úÖ Sistema inicializado com recursos de seguran√ßa aprimorados!');
        });
    </script>
</body>
</html>
